<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Start Page</title>
        <style>
            body {
                height: 100vh;
                overflow: hidden;
                background-color: #000;
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                transition: background-image 1s ease-in-out;
            }

            .error-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                color: white;
                text-align: center;
                padding: 20px;
                background: rgba(0, 0, 0, 0.8);
            }

            .error-title {
                font-size: 2rem;
                margin-bottom: 20px;
                color: #ff6b6b;
            }

            .error-message {
                font-size: 1rem;
                margin-bottom: 30px;
                line-height: 1.6;
            }

            .error-steps {
                text-align: left;
                max-width: 500px;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top: 4px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <script>
            class SafariBackground {
                constructor() {
                    this.unsplashAccessKey = 'sOtYUya2BmlLxB977Bw1vEQhxtA2k_taf4eJMuV_1SI' // Production API key
                    this.currentImageIndex = 0
                    this.images = []
                    this.allImages = []
                    this.changeInterval = 30 // minutes
                    this.timer = null
                    this.lastChangeTime = localStorage.getItem('lastImageChange')
                    this.setupTimer()

                    // Configuration that can be easily changed
                    this.config = {
                        collectionId: '461370', // Unsplash collection ID
                        changeIntervalMinutes: this.changeInterval,
                        preloadImages: 5,
                        transitionDuration: 1000, // ms
                    }

                    this.init()
                }

                async init() {
                    await this.loadConfiguration()
                    await this.fetchImages()
                    this.startRotation()
                    this.setupEventListeners()
                }

                async loadConfiguration() {
                    // Configuration is set directly in constructor
                    // No additional setup needed
                }

                getApiKey() {
                    // API key is set directly in constructor for simplicity
                    return this.unsplashAccessKey
                }

                showApiKeyPrompt() {
                    this.showError('Please set up your Unsplash API key.')
                }

                async fetchImages() {
                    if (!this.unsplashAccessKey) {
                        return
                    }

                    try {
                        const response = await fetch(
                            `https://api.unsplash.com/collections/${this.config.collectionId}/photos?per_page=30&client_id=${this.unsplashAccessKey}`,
                        )

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`)
                        }

                        const data = await response.json()
                        // Store all images from collection and select random ones
                        this.allImages = Array.isArray(data) ? data : [data]
                        this.preloadRandomImages()

                        if (this.images.length === 0) {
                            this.showError('No images found in the collection. Please check the collection ID.')
                            return
                        }

                        this.displayCurrentImage()
                        this.startRotation()
                    } catch (error) {
                        console.error('Error fetching images:', error)
                        this.showError(`Failed to load images: ${error.message}`)
                    }
                }

                displayCurrentImage() {
                    if (this.images.length === 0) return

                    const currentImage = this.images[this.currentImageIndex]
                    const imageUrl = currentImage.urls.full

                    // Create a new image object to preload
                    const img = new Image()
                    img.onload = () => {
                        document.body.style.backgroundImage = `url(${imageUrl})`
                        this.hideLoading()
                    }
                    img.onerror = () => {
                        this.showError('Failed to load image. Please try again later.')
                    }
                    img.src = imageUrl
                }

                preloadRandomImages() {
                    if (this.allImages.length === 0) return

                    // Select 5 random images from the collection
                    const randomIndices = []
                    while (randomIndices.length < Math.min(5, this.allImages.length)) {
                        const randomIndex = Math.floor(Math.random() * this.allImages.length)
                        if (!randomIndices.includes(randomIndex)) {
                            randomIndices.push(randomIndex)
                        }
                    }

                    this.images = randomIndices.map((index) => this.allImages[index])
                }

                nextImage() {
                    if (this.images.length === 0) {
                        this.fetchImages()
                        return
                    }

                    // Select new random image
                    let newIndex
                    do {
                        newIndex = Math.floor(Math.random() * this.images.length)
                    } while (newIndex === this.currentImageIndex && this.images.length > 1)

                    this.currentImageIndex = newIndex
                    this.displayCurrentImage()
                    this.updateLastChangeTime()
                }

                updateLastChangeTime() {
                    this.lastChangeTime = Date.now()
                    localStorage.setItem('lastImageChange', this.lastChangeTime.toString())
                }

                checkTimeBasedChange() {
                    if (!this.lastChangeTime) {
                        this.updateLastChangeTime()
                        return
                    }

                    const now = Date.now()
                    const timeElapsed = now - parseInt(this.lastChangeTime)
                    const intervalMs = (this.config?.changeIntervalMinutes || 30) * 60 * 1000 // 30 minutes

                    if (timeElapsed >= intervalMs) {
                        this.nextImage()
                    }
                }

                setupTimer() {
                    // Check immediately when page loads
                    this.checkTimeBasedChange()

                    // Set up interval to check every minute
                    setInterval(() => {
                        this.checkTimeBasedChange()
                    }, 60000) // Check every minute
                }

                startRotation() {
                    // Clear any existing timer
                    if (this.timer) {
                        clearInterval(this.timer)
                    }

                    // Start new timer
                    this.timer = setInterval(() => {
                        this.nextImage()
                    }, this.config.changeIntervalMinutes * 60 * 1000)
                }

                setupEventListeners() {
                    // Allow manual refresh with click only
                    document.addEventListener('click', () => {
                        this.nextImage()
                    })
                }

                showLoading() {
                    // Create loading spinner element
                    if (!document.querySelector('.loading-spinner')) {
                        const spinner = document.createElement('div')
                        spinner.className = 'loading-spinner'
                        document.body.appendChild(spinner)
                    }
                }

                hideLoading() {
                    // Remove loading spinner
                    const spinner = document.querySelector('.loading-spinner')
                    if (spinner) {
                        spinner.remove()
                    }
                }

                showError(message) {
                    console.error('Start Page Error:', message)

                    document.body.innerHTML = `
                        <div class="error-container">
                            <div class="error-title">Setup Required</div>
                            <div class="error-message">${message}</div>
                            <div class="error-steps">
                                <p>To set up this application:</p>
                                <ol>
                                    <li>Get a free Unsplash API key from <a href="https://unsplash.com/developers" target="_blank" style="color: #4ecdc4;">Unsplash Developers</a></li>
                                    <li>Add it as a GitHub Secret named UNSPLASH_ACCESS_KEY</li>
                                    <li>Or add it directly to the HTML file</li>
                                </ol>
                            </div>
                        </div>
                    `
                }
            }

            // Initialize the application when DOM is loaded
            document.addEventListener('DOMContentLoaded', () => {
                new SafariBackground()
            })
        </script>
    </body>
</html>
